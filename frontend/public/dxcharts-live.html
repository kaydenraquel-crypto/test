<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DXcharts Live Test - NovaSignal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #0f0f0f;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }
        
        .container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 20px;
        }
        
        .title {
            color: #4fc3f7;
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .stat {
            font-size: 14px;
        }
        
        .price {
            font-size: 18px;
            font-weight: bold;
        }
        
        .positive { color: #4caf50; }
        .negative { color: #f44336; }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 16px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background-color: #555;
        }
        
        .btn.active {
            background-color: #4fc3f7;
        }
        
        .btn:disabled {
            background-color: #222;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn.success { background-color: #4caf50; }
        .btn.warning { background-color: #ff9800; }
        .btn.danger { background-color: #f44336; }
        
        .status {
            margin-bottom: 15px;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .alert.loading {
            background-color: #1a2332;
            color: #4fc3f7;
            border-left: 4px solid #4fc3f7;
        }
        
        .alert.error {
            background-color: #2d1b1b;
            color: #f44336;
            border-left: 4px solid #f44336;
        }
        
        .alert.success {
            background-color: #1b2d1b;
            color: #4caf50;
            border-left: 4px solid #4caf50;
        }
        
        .chart-container {
            width: 100%;
            height: 600px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            gap: 15px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top: 3px solid #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4fc3f7;
        }
        
        .card.success {
            border-left-color: #4caf50;
        }
        
        .card.warning {
            border-left-color: #ff9800;
        }
        
        .card h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }
        
        .card.success h3 {
            color: #4caf50;
        }
        
        .card.warning h3 {
            color: #ff9800;
        }
        
        .card ul {
            list-style: none;
        }
        
        .card li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .card li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #4caf50;
        }
        
        .debug {
            background-color: #111;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .debug h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">
                <span>üöÄ</span>
                DXcharts Live Integration Test
            </h1>
            
            <div class="stats">
                <div class="stat">
                    <strong>Symbol:</strong> BTCUSDT (crypto)
                </div>
                <div class="stat" id="priceDisplay">
                    <strong>Price:</strong> <span id="currentPrice">Loading...</span>
                </div>
                <div class="stat" id="changeDisplay">
                    <strong>Change:</strong> <span id="priceChange">-</span>
                </div>
                <div class="stat">
                    <strong>Data:</strong> <span id="dataCount">0</span> candles (<span id="dataSource">none</span>)
                </div>
                <div class="stat">
                    <strong>Status:</strong> <span id="chartStatus">Initializing...</span>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <button id="loadSample" class="btn active">üìä Load Sample Data</button>
            <button id="loadReal" class="btn">üåê Load Real Data</button>
            <button id="testChart" class="btn">üß™ Test Chart Creation</button>
            <button class="btn warning" onclick="window.location.reload()">üîÑ Reload</button>
            <a href="/" class="btn danger">‚Üê Back to Main App</a>
        </div>
        
        <!-- Status Display -->
        <div id="statusDisplay"></div>
        
        <!-- Chart Container -->
        <div class="chart-container" id="chartContainer">
            <div class="chart-loading">
                <div style="font-size: 3rem; margin-bottom: 10px;">üìä</div>
                <div style="font-size: 1.2rem; margin-bottom: 15px;">Initializing DXcharts...</div>
                <div class="spinner"></div>
                <div style="font-size: 0.9rem; color: #888; text-align: center;">
                    Professional-grade financial charting engine<br>
                    Loading chart renderer and data processing...
                </div>
            </div>
        </div>
        
        <!-- Comparison Cards -->
        <div class="comparison">
            <div class="card success">
                <h3>‚úÖ DXcharts Benefits</h3>
                <ul>
                    <li>Professional financial charting engine</li>
                    <li>Built-in technical indicators (RSI, MACD, BB)</li>
                    <li>Drawing tools and annotations</li>
                    <li>Better performance with large datasets</li>
                    <li>No spacing or rendering issues</li>
                    <li>Order management integration ready</li>
                    <li>Advanced customization options</li>
                    <li>Optimized for trading platforms</li>
                </ul>
            </div>
            
            <div class="card warning">
                <h3>üîß Current Issues Being Resolved</h3>
                <ul>
                    <li>Candlestick spacing problems</li>
                    <li>Data loading inconsistencies</li>
                    <li>Chart rendering and scaling bugs</li>
                    <li>Limited indicator support</li>
                    <li>Performance issues with real-time data</li>
                    <li>Time spent debugging instead of building</li>
                    <li>Unprofessional chart appearance</li>
                    <li>Lack of advanced trading features</li>
                </ul>
            </div>
        </div>
        
        <!-- Debug Information -->
        <div class="debug">
            <h3>üîç Integration Debug Information</h3>
            <div id="debugInfo">
                <div>Chart Library: DXcharts Lite v2.7.15</div>
                <div>Integration Method: Dynamic Import + NPM Package</div>
                <div>Data Source: NovaSignal Backend API</div>
                <div>Status: <span id="debugStatus">Initializing...</span></div>
                <div>Last Update: <span id="lastUpdate">-</span></div>
                <div>Errors: <span id="errorCount">0</span></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let chartInstance = null;
        let chartData = [];
        let isLoading = false;
        let dataSource = 'none';
        let errorCount = 0;

        // DOM elements
        const elements = {
            chartContainer: document.getElementById('chartContainer'),
            statusDisplay: document.getElementById('statusDisplay'),
            currentPrice: document.getElementById('currentPrice'),
            priceChange: document.getElementById('priceChange'),
            changeDisplay: document.getElementById('changeDisplay'),
            dataCount: document.getElementById('dataCount'),
            dataSource: document.getElementById('dataSource'),
            chartStatus: document.getElementById('chartStatus'),
            debugStatus: document.getElementById('debugStatus'),
            lastUpdate: document.getElementById('lastUpdate'),
            errorCount: document.getElementById('errorCount'),
            loadSample: document.getElementById('loadSample'),
            loadReal: document.getElementById('loadReal'),
            testChart: document.getElementById('testChart')
        };

        // Utility functions
        function showStatus(message, type = 'loading') {
            const alertClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'loading';
            elements.statusDisplay.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        }

        function updateDebugInfo(status, error = null) {
            elements.debugStatus.textContent = status;
            elements.lastUpdate.textContent = new Date().toLocaleTimeString();
            if (error) {
                errorCount++;
                elements.errorCount.textContent = errorCount;
            }
        }

        function updateStats() {
            elements.dataCount.textContent = chartData.length;
            elements.dataSource.textContent = dataSource;
            
            if (chartData.length > 0) {
                const latest = chartData[chartData.length - 1];
                const price = latest.close || latest.price || 0;
                elements.currentPrice.textContent = `$${price.toLocaleString()}`;
                
                if (chartData.length > 1) {
                    const previous = chartData[chartData.length - 2];
                    const change = price - (previous.close || previous.price || 0);
                    const changePercent = ((change / (previous.close || previous.price || 1)) * 100).toFixed(2);
                    const isPositive = change >= 0;
                    
                    elements.priceChange.textContent = `${isPositive ? '+' : ''}${change.toFixed(2)} (${changePercent}%)`;
                    elements.changeDisplay.className = `stat ${isPositive ? 'positive' : 'negative'}`;
                }
            }
        }

        // Data generation functions
        function generateSampleData(count = 200) {
            const data = [];
            const basePrice = 45000;
            const baseTime = Date.now() - (count * 5 * 60 * 1000); // 5 minutes apart
            
            let price = basePrice;
            
            for (let i = 0; i < count; i++) {
                const time = baseTime + (i * 5 * 60 * 1000);
                const change = (Math.random() - 0.5) * 1000;
                const open = price;
                const close = Math.max(1000, open + change);
                const high = Math.max(open, close) + Math.random() * 200;
                const low = Math.min(open, close) - Math.random() * 200;
                
                data.push({
                    time: Math.floor(time / 1000), // Convert to seconds
                    open: Number(open.toFixed(2)),
                    high: Number(high.toFixed(2)),
                    low: Number(low.toFixed(2)),
                    close: Number(close.toFixed(2)),
                    volume: Number((Math.random() * 100).toFixed(4))
                });
                
                price = close;
            }
            
            return data;
        }

        // Chart functions
        async function initializeChart() {
            try {
                elements.chartStatus.textContent = 'Loading DXcharts...';
                updateDebugInfo('Loading DXcharts library...');
                
                showStatus('üöÄ Initializing DXcharts professional charting engine...', 'loading');
                
                // Try to import DXcharts
                const DXChart = await import('@devexperts/dxcharts-lite');
                
                updateDebugInfo('DXcharts loaded, creating chart instance...');
                
                // Clear container
                elements.chartContainer.innerHTML = '';
                
                // Create chart with professional configuration
                chartInstance = DXChart.createChart(elements.chartContainer, {
                    layout: {
                        background: { color: '#1a1a1a' },
                        textColor: '#ffffff'
                    },
                    grid: {
                        vertLines: { color: '#2a2a2a', style: 1, visible: true },
                        horzLines: { color: '#2a2a2a', style: 1, visible: true }
                    },
                    crosshair: {
                        mode: 0,
                        vertLine: { color: '#4fc3f7', width: 1, style: 0 },
                        horzLine: { color: '#4fc3f7', width: 1, style: 0 }
                    },
                    timeScale: {
                        borderColor: '#4a5568',
                        timeVisible: true,
                        secondsVisible: false
                    },
                    rightPriceScale: {
                        borderColor: '#4a5568',
                        scaleMargins: { top: 0.1, bottom: 0.1 }
                    }
                });
                
                elements.chartStatus.textContent = '‚úÖ Ready';
                updateDebugInfo('Chart initialized successfully');
                showStatus('‚úÖ DXcharts initialized successfully! Professional charting engine ready.', 'success');
                
                // Load sample data by default
                setTimeout(loadSampleData, 500);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Chart initialization failed:', error);
                elements.chartStatus.textContent = '‚ùå Failed';
                updateDebugInfo('Chart initialization failed', error);
                showStatus(`‚ùå Chart initialization failed: ${error.message}`, 'error');
                
                // Show fallback content
                elements.chartContainer.innerHTML = `
                    <div class="chart-loading">
                        <div style="font-size: 3rem; margin-bottom: 10px; color: #f44336;">‚ö†Ô∏è</div>
                        <div style="font-size: 1.2rem; margin-bottom: 15px; color: #f44336;">Chart Initialization Failed</div>
                        <div style="font-size: 0.9rem; color: #888; text-align: center; max-width: 80%;">
                            ${error.message}<br><br>
                            This might be due to module loading issues. The DXcharts package is installed correctly,
                            but may require bundler configuration for proper importing.
                        </div>
                        <button class="btn" onclick="window.location.reload()" style="margin-top: 20px;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
                
                return false;
            }
        }

        function updateChart() {
            if (!chartInstance || chartData.length === 0) return;
            
            try {
                // Convert data to DXcharts format
                const dxData = chartData.map(item => ({
                    time: item.time * (item.time > 1e10 ? 1 : 1000), // Handle seconds vs milliseconds
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                    volume: item.volume || 0
                }));
                
                // Update chart
                chartInstance.setData({ candles: dxData });
                updateDebugInfo('Chart data updated successfully');
                console.log('‚úÖ Chart updated with', dxData.length, 'candles');
                
            } catch (error) {
                console.error('‚ùå Chart update failed:', error);
                updateDebugInfo('Chart update failed', error);
                showStatus(`‚ùå Chart update failed: ${error.message}`, 'error');
            }
        }

        // Data loading functions
        function loadSampleData() {
            if (isLoading) return;
            
            console.log('üìä Loading sample data...');
            isLoading = true;
            dataSource = 'sample';
            
            elements.loadSample.classList.add('active');
            elements.loadReal.classList.remove('active');
            elements.loadSample.disabled = true;
            elements.loadReal.disabled = true;
            
            showStatus('üìä Generating realistic sample Bitcoin data...', 'loading');
            
            setTimeout(() => {
                try {
                    chartData = generateSampleData(200);
                    updateChart();
                    updateStats();
                    showStatus('‚úÖ Sample data loaded successfully! Professional candlestick chart rendered.', 'success');
                    console.log('‚úÖ Sample data loaded:', chartData.length, 'candles');
                } catch (error) {
                    console.error('‚ùå Sample data loading failed:', error);
                    showStatus('‚ùå Sample data loading failed', 'error');
                    updateDebugInfo('Sample data loading failed', error);
                } finally {
                    isLoading = false;
                    elements.loadSample.disabled = false;
                    elements.loadReal.disabled = false;
                }
            }, 800);
        }

        async function loadRealData() {
            if (isLoading) return;
            
            console.log('üåê Loading real API data...');
            isLoading = true;
            dataSource = 'api';
            
            elements.loadReal.classList.add('active');
            elements.loadSample.classList.remove('active');
            elements.loadSample.disabled = true;
            elements.loadReal.disabled = true;
            
            showStatus('üåê Loading real Bitcoin data from NovaSignal API...', 'loading');
            
            try {
                const response = await fetch(
                    'http://localhost:8000/api/history?symbol=BTCUSDT&market=crypto&interval=60&days=1'
                );
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üîç API Response:', data);
                
                if (!data.ohlc || !Array.isArray(data.ohlc)) {
                    throw new Error('Invalid API response format');
                }
                
                // Convert API data
                chartData = data.ohlc.map(item => ({
                    time: item.ts || item.time || item.timestamp,
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                    volume: item.volume || 0
                })).filter(item => 
                    item.time && 
                    Number.isFinite(item.open) && 
                    Number.isFinite(item.high) && 
                    Number.isFinite(item.low) && 
                    Number.isFinite(item.close)
                );
                
                if (chartData.length === 0) {
                    throw new Error('No valid candle data received from API');
                }
                
                updateChart();
                updateStats();
                showStatus(`‚úÖ Real data loaded successfully! ${chartData.length} candles from NovaSignal API.`, 'success');
                console.log('‚úÖ Real data loaded:', chartData.length, 'candles');
                
            } catch (error) {
                console.error('‚ùå Real data loading failed:', error);
                showStatus(`‚ùå Real data loading failed: ${error.message}`, 'error');
                updateDebugInfo('Real data loading failed', error);
            } finally {
                isLoading = false;
                elements.loadSample.disabled = false;
                elements.loadReal.disabled = false;
            }
        }

        function testChartCreation() {
            showStatus('üß™ Testing chart creation capabilities...', 'loading');
            
            setTimeout(() => {
                if (chartInstance) {
                    showStatus('‚úÖ Chart creation test passed! DXcharts instance is active and ready.', 'success');
                    updateDebugInfo('Chart creation test passed');
                } else {
                    showStatus('‚ùå Chart creation test failed! No active chart instance.', 'error');
                    updateDebugInfo('Chart creation test failed');
                }
            }, 1000);
        }

        // Event listeners
        elements.loadSample.addEventListener('click', loadSampleData);
        elements.loadReal.addEventListener('click', loadRealData);
        elements.testChart.addEventListener('click', testChartCreation);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DXcharts Live Test starting...');
            initializeChart();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && chartInstance && chartData.length > 0) {
                // Refresh chart when page becomes visible again
                setTimeout(() => {
                    updateChart();
                    updateStats();
                }, 100);
            }
        });
    </script>
</body>
</html>